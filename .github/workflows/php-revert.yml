name: Revert PHP Releases

on:
  workflow_dispatch:
    inputs:
      minimum_version:
        description: 'Minimum version (e.g. 8.4.3)'
        required: false
        default: '0.0.0'
      maximum_version:
        description: 'Maximum version (empty = latest)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Essential to see all tags and history

      - name: Delete Releases and Tags for Specific Commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIN_VER: ${{ inputs.minimum_version }}
          MAX_VER: ${{ inputs.maximum_version }}
          TARGET_COMMIT: "b249226a4b2e29219091637c9658c2024e709d3a"
        run: |
          if [ -z "$MAX_VER" ]; then MAX_VER="999.999.999"; fi

          echo "üéØ Target Commit: $TARGET_COMMIT"
          echo "üéØ Target Range: v$MIN_VER -> v$MAX_VER"
          echo "----------------------------------------"

          # Get all tags pointing EXACTLY to the target commit
          # git tag --points-at filters the list to that specific hash
          git tag --points-at "$TARGET_COMMIT" | grep "^v" | sed 's/^v//' | sort -V | while read version; do
            
            # Version range check (Min)
            if [ "$(echo -e "$version\n$MIN_VER" | sort -V | head -n1)" != "$MIN_VER" ]; then
              continue
            fi

            # Version range check (Max)
            if [ "$(echo -e "$version\n$MAX_VER" | sort -V | tail -n1)" != "$MAX_VER" ]; then
              continue
            fi

            TAG="v$version"
            echo "üî• Deleting $TAG..."
            
            # Delete Release (and associated tag via --cleanup-tag)
            if ! gh release delete "$TAG" --cleanup-tag --yes 2>/dev/null; then
               # Fallback: forcefully delete remote tag if release doesn't exist
               git push origin --delete "$TAG" 2>/dev/null || echo "   ‚ö†Ô∏è Could not delete $TAG"
            fi
            
          done
          
          echo "----------------------------------------"
          echo "‚úÖ Cleanup finished for commit $TARGET_COMMIT."
